<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Medication Shelf Tracker</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f6fb;
      margin: 0;
      padding: 20px;
    }

    .app-container {
      max-width: 1000px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      padding: 24px 24px 30px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 24px;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-bottom: 18px;
    }

    /* Circle navigation */
    .nav-circles {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .nav-circle-btn {
      width: 110px;
      height: 110px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #e5e7eb;
      color: #111827;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.2s ease, color 0.2s ease;
    }

    .nav-circle-btn span.icon {
      font-size: 22px;
      margin-bottom: 4px;
    }

    .nav-circle-btn.active {
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 6px 16px rgba(37,99,235,0.3);
    }

    .nav-circle-btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 2px 6px rgba(0,0,0,0.18) inset;
    }

    /* Panels */
    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }

    /* Add form */
    .add-form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
    }

    .add-form input,
    .add-form select {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccd2e4;
      font-size: 14px;
      flex: 1;
      min-width: 140px;
    }

    .add-form input[type="number"] {
      max-width: 120px;
    }

    .add-form input[type="date"] {
      max-width: 170px;
    }

    .add-form .barcode-group {
      display: flex;
      gap: 6px;
      align-items: center;
      flex: 1.2;
      min-width: 180px;
    }

    .add-form button {
      padding: 9px 16px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: white;
      font-weight: 600;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.2s ease;
      white-space: nowrap;
    }

    .add-form button:hover {
      background: #1d4ed8;
    }

    .add-form button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15) inset;
    }

    .scan-btn {
      background: #10b981;
    }

    .scan-btn:hover {
      background: #059669;
    }

    /* Shelf tracker cards */
    .med-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }

    .med-card {
      background: #f9fafb;
      border-radius: 14px;
      padding: 14px 16px 16px;
      border: 1px solid #e0e3f0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .med-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .med-name {
      font-weight: 600;
      font-size: 15px;
    }

    .med-qty {
      font-size: 13px;
      color: #4b5563;
    }

    .qty-number {
      font-weight: 700;
      font-size: 17px;
      color: #111827;
      margin-left: 4px;
    }

    .med-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #6b7280;
      gap: 8px;
      flex-wrap: wrap;
    }

    .exp-text span {
      font-weight: 600;
      color: #111827;
    }

    .barcode-text {
      font-size: 11px;
      color: #9ca3af;
    }

    .edit-exp-btn {
      border: none;
      background: transparent;
      color: #2563eb;
      font-size: 12px;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 2px;
    }

    .amount-input {
      width: 70px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d0d7ec;
      font-size: 14px;
      text-align: center;
    }

    .btn-circle {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: none;
      font-size: 22px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #e5edff;
      color: #1d4ed8;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.2s ease;
    }

    .btn-circle.plus {
      background: #dcfce7;
      color: #16a34a;
    }

    .btn-circle.minus {
      background: #fee2e2;
      color: #b91c1c;
    }

    .btn-circle:hover {
      filter: brightness(0.96);
    }

    .btn-circle:active {
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.18) inset;
    }

    .delete-btn {
      align-self: flex-end;
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 12px;
      cursor: pointer;
      padding: 0;
    }

    .delete-btn:hover {
      color: #ef4444;
      text-decoration: underline;
    }

    /* Inventory & Expiring tables */
    .inventory-summary,
    .expiring-summary {
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 8px;
    }

    table.inventory-table,
    table.expiring-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 10px;
    }

    table.inventory-table th,
    table.inventory-table td,
    table.expiring-table th,
    table.expiring-table td {
      border: 1px solid #e5e7eb;
      padding: 8px;
      text-align: left;
    }

    table.inventory-table th,
    table.expiring-table th {
      background: #f3f4f6;
      font-weight: 600;
    }

    table.inventory-table tbody tr:nth-child(even),
    table.expiring-table tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .text-right {
      text-align: right;
    }

    /* Orders */
    .orders-summary {
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 12px;
    }

    .order-card {
      background: #f9fafb;
      border-radius: 14px;
      border: 1px solid #e0e3f0;
      padding: 16px 18px;
      max-width: 520px;
    }

    .order-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .order-line {
      font-size: 14px;
      margin-bottom: 6px;
    }

    .order-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .btn-primary {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #16a34a;
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.2s ease;
    }

    .btn-primary:hover {
      background: #15803d;
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15) inset;
    }

    .btn-secondary {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #e5e7eb;
      color: #374151;
      font-size: 14px;
      font-weight: 500;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.2s ease;
    }

    .btn-secondary:hover {
      background: #d4d4d8;
    }

    .btn-secondary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15) inset;
    }

    /* Overlays (scanner + adjust) */
    .overlay-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .overlay-modal.active {
      display: flex;
    }

    .overlay-inner {
      background: #111827;
      border-radius: 16px;
      padding: 16px;
      max-width: 500px;
      width: 94%;
      color: #e5e7eb;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    }

    .overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .scanner-viewport {
      width: 100%;
      height: 260px;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .overlay-helper {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
    }

    .overlay-close-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      cursor: pointer;
      background: #f87171;
      color: #fff;
    }

    /* PHONE / SMALL SCREEN */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .app-container {
        padding: 14px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      }

      .nav-circles {
        gap: 12px;
      }

      .nav-circle-btn {
        width: 46%;
        max-width: none;
        height: 90px;
        font-size: 12px;
      }

      .nav-circle-btn span.icon {
        font-size: 20px;
        margin-bottom: 2px;
      }

      .add-form {
        flex-direction: column;
        align-items: stretch;
      }

      .add-form input,
      .add-form select,
      .add-form button,
      .add-form .barcode-group {
        width: 100%;
      }

      .add-form button {
        width: 100%;
        text-align: center;
      }

      .med-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .med-card {
        border-radius: 10px;
      }

      #inventoryContent,
      #expiringContent,
      #orderContent {
        overflow-x: auto;
      }

      table.inventory-table,
      table.expiring-table {
        min-width: 500px;
        font-size: 13px;
      }

      .order-card {
        max-width: 100%;
      }

      .overlay-inner {
        max-width: 100%;
        width: 96%;
        padding: 12px;
      }

      .scanner-viewport {
        height: 220px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <h1>Medication Shelf Tracker</h1>
    <div class="subtitle">
      Welcome. Choose a tool below. Techs: use <strong>‚àí</strong> when you pull from the shelf, <strong>+</strong> when you restock.
    </div>

    <!-- CIRCLE NAV -->
    <div class="nav-circles">
      <button class="nav-circle-btn active" data-target="trackerTab">
        <span class="icon">üì¶</span>
        Shelf Tracker
      </button>
      <button class="nav-circle-btn" data-target="inventoryTab">
        <span class="icon">üìã</span>
        Inventory
      </button>
      <button class="nav-circle-btn" data-target="expiringTab">
        <span class="icon">‚è∞</span>
        Expiring
      </button>
      <button class="nav-circle-btn" data-target="ordersTab">
        <span class="icon">üßæ</span>
        Orders
      </button>
    </div>

    <!-- TAB 1: Shelf Tracker -->
    <div id="trackerTab" class="tab-panel active">
      <div class="add-form">
        <input type="text" id="medNameInput" placeholder="Medication name (e.g., Ceftriaxone 1 g)" />
        <input type="number" id="medStartQtyInput" placeholder="Starting qty" min="0" />
        <input type="date" id="medExpInput" placeholder="Expiration date" />
        <div class="barcode-group">
          <input type="text" id="medBarcodeInput" placeholder="Barcode / NDC (required)" />
          <button type="button" class="scan-btn" id="openScannerBtn">Scan</button>
        </div>
        <button id="addMedBtn">Add Medication</button>
      </div>

      <!-- Scan to adjust stock -->
      <div style="margin-bottom:14px;">
        <button type="button" class="scan-btn" id="openAdjustScanBtn">
          Scan to Adjust Stock
        </button>
      </div>

      <div id="medList" class="med-list"></div>
    </div>

    <!-- TAB 2: Inventory View -->
    <div id="inventoryTab" class="tab-panel">
      <div class="inventory-summary">
        This tab shows the current inventory for all tracked medications.
      </div>
      <div id="inventoryContent"></div>
    </div>

    <!-- TAB 3: Expiring (within 3 months) -->
    <div id="expiringTab" class="tab-panel">
      <div class="expiring-summary">
        Medications with expiration dates within the next <strong>3 months</strong>.
      </div>
      <div id="expiringContent"></div>
    </div>

    <!-- TAB 4: Orders View -->
    <div id="ordersTab" class="tab-panel">
      <div class="add-form" style="margin-bottom: 16px;">
        <select id="orderMedSelect">
          <option value="">Select medication for order...</option>
        </select>
        <input type="number" id="orderQtyInput" placeholder="Order qty" min="1" />
        <button id="addOrderBtn">Add Order</button>
      </div>

      <div class="orders-summary">
        Only one order is shown at a time. When you click <strong>Accept</strong>, that amount is
        automatically subtracted from the shelf.
      </div>

      <div id="orderContent"></div>
    </div>
  </div>

  <!-- Scanner Modal -->
  <div id="scannerModal" class="overlay-modal">
    <div class="overlay-inner">
      <div class="overlay-header">
        <div>Scan Barcode</div>
        <button id="closeScannerBtn" class="overlay-close-btn">Close</button>
      </div>
      <div id="scannerViewport" class="scanner-viewport"></div>
      <div class="overlay-helper">
        Point the iPad/phone camera at the barcode.
      </div>
    </div>
  </div>

  <!-- Adjust Modal -->
  <div id="adjustModal" class="overlay-modal">
    <div class="overlay-inner">
      <div class="overlay-header">
        <div>Adjust Stock</div>
        <button id="closeAdjustBtn" class="overlay-close-btn">Close</button>
      </div>
      <div id="adjustInfo" class="overlay-helper" style="margin-bottom:8px;"></div>
      <div style="margin-top:4px; display:flex; gap:8px; align-items:center;">
        <label style="font-size:13px;">
          Amount:
          <input type="number" id="adjustAmountInput" value="1" min="1"
                 style="width:80px; margin-left:4px; padding:4px 6px; border-radius:8px; border:1px solid #4b5563; font-size:13px;">
        </label>
      </div>
      <div class="order-actions" style="margin-top:12px;">
        <button class="btn-primary" id="adjustSubtractBtn">Pull (‚àí)</button>
        <button class="btn-secondary" id="adjustAddBtn">Restock (+)</button>
      </div>
    </div>
  </div>

  <!-- Barcode library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

  <script>
    // ====== GOOGLE APPS SCRIPT WEB APP URL ======
    const API_URL = "https://script.google.com/macros/s/AKfycby84DRy6BQRMUR6nMni900gb4G1F3yCUDptFUzzUbkPqdb0wtwBZO_culCX8tcKZopoKg/exec";

    // ====== LOCAL STORAGE KEYS ======
    const STORAGE_KEY = "medShelfTrackerData";
    const ORDER_STORAGE_KEY = "medShelfOrdersData";

    // ====== LOCAL STORAGE HELPERS ======
    function loadMedsLocal() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) return [];
      try {
        const meds = JSON.parse(saved);
        return meds.map(m => ({
          id: m.id,
          name: m.name,
          qty: m.qty ?? 0,
          exp: m.exp || "",
          barcode: m.barcode || ""
        }));
      } catch (e) {
        console.error("Error parsing local meds:", e);
        return [];
      }
    }

    function saveMedsLocal(meds) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
    }

    function loadOrders() {
      const saved = localStorage.getItem(ORDER_STORAGE_KEY);
      if (!saved) return [];
      try {
        return JSON.parse(saved);
      } catch (e) {
        console.error("Error parsing orders:", e);
        return [];
      }
    }

    function saveOrders(orders) {
      localStorage.setItem(ORDER_STORAGE_KEY, JSON.stringify(orders));
    }

    // ====== SERVER SYNC HELPERS ======
    async function fetchMedsFromServer() {
      try {
        const res = await fetch(API_URL, {
          method: "GET"
        });
        if (!res.ok) {
          console.error("GET meds failed:", res.status, await res.text());
          return null;
        }
        const data = await res.json();
        if (!Array.isArray(data)) return null;
        return data;
      } catch (e) {
        console.error("GET meds error:", e);
        return null;
      }
    }

    async function syncMedsToServer(meds) {
      try {
        const payload = {
          action: "syncAll",
          meds: meds.map(m => ({
            name: m.name,
            qty: m.qty ?? 0,
            exp: m.exp || "",
            barcode: m.barcode || ""
          }))
        };

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        console.log("Sync result:", data);
      } catch (e) {
        console.error("POST meds error:", e);
      }
    }

    function saveMeds(meds) {
      // Save locally
      saveMedsLocal(meds);
      // Sync to Google Sheet
      syncMedsToServer(meds).catch(err => console.error("Sync error:", err));
    }

    // ====== APP STATE ======
    let medications = [];
    let orders = [];

    // ====== DOM ELEMENTS ======
    const medListEl = document.getElementById("medList");
    const medNameInput = document.getElementById("medNameInput");
    const medStartQtyInput = document.getElementById("medStartQtyInput");
    const medExpInput = document.getElementById("medExpInput");
    const medBarcodeInput = document.getElementById("medBarcodeInput");
    const addMedBtn = document.getElementById("addMedBtn");
    const inventoryContent = document.getElementById("inventoryContent");
    const expiringContent = document.getElementById("expiringContent");

    const orderMedSelect = document.getElementById("orderMedSelect");
    const orderQtyInput = document.getElementById("orderQtyInput");
    const addOrderBtn = document.getElementById("addOrderBtn");
    const orderContent = document.getElementById("orderContent");

    const scannerModal = document.getElementById("scannerModal");
    const scannerViewport = document.getElementById("scannerViewport");
    const openScannerBtn = document.getElementById("openScannerBtn");
    const openAdjustScanBtn = document.getElementById("openAdjustScanBtn");
    const closeScannerBtn = document.getElementById("closeScannerBtn");

    const adjustModal = document.getElementById("adjustModal");
    const adjustInfo = document.getElementById("adjustInfo");
    const adjustAmountInput = document.getElementById("adjustAmountInput");
    const adjustSubtractBtn = document.getElementById("adjustSubtractBtn");
    const adjustAddBtn = document.getElementById("adjustAddBtn");
    const closeAdjustBtn = document.getElementById("closeAdjustBtn");

    let scannerActive = false;
    let scannerMode = "add"; // "add" or "adjust"
    let adjustMedId = null;

    // ====== RENDER: SHELF ======
    function renderMeds() {
      medListEl.innerHTML = "";

      medications.forEach(med => {
        const card = document.createElement("div");
        card.className = "med-card";
        card.dataset.id = med.id;

        const expLabel = med.exp ? med.exp : "Not set";
        const barcodeLabel = med.barcode ? `Barcode: ${med.barcode}` : "No barcode";

        card.innerHTML = `
          <div class="med-header">
            <div class="med-name">${med.name}</div>
            <div class="med-qty">
              On shelf: <span class="qty-number">${med.qty}</span>
            </div>
          </div>
          <div class="med-meta">
            <div class="exp-text">
              Exp: <span>${expLabel}</span>
              <button class="edit-exp-btn">Edit</button>
            </div>
            <div class="barcode-text">${barcodeLabel}</div>
          </div>
          <div class="controls-row">
            <button class="btn-circle minus">‚àí</button>
            <input type="number" class="amount-input" min="1" value="1" />
            <button class="btn-circle plus">+</button>
          </div>
          <button class="delete-btn">Remove</button>
        `;

        const minusBtn = card.querySelector(".minus");
        const plusBtn = card.querySelector(".plus");
        const amountInput = card.querySelector(".amount-input");
        const deleteBtn = card.querySelector(".delete-btn");
        const qtyDisplay = card.querySelector(".qty-number");
        const editExpBtn = card.querySelector(".edit-exp-btn");
        const expSpan = card.querySelector(".exp-text span");

        minusBtn.addEventListener("click", () => {
          let amt = parseInt(amountInput.value, 10);
          if (isNaN(amt) || amt <= 0) amt = 1;
          med.qty = Math.max(0, med.qty - amt);
          qtyDisplay.textContent = med.qty;
          saveMeds(medications);
          renderInventory();
          renderExpiring();
          renderOrderSelectOptions();
        });

        plusBtn.addEventListener("click", () => {
          let amt = parseInt(amountInput.value, 10);
          if (isNaN(amt) || amt <= 0) amt = 1;
          med.qty += amt;
          qtyDisplay.textContent = med.qty;
          saveMeds(medications);
          renderInventory();
          renderExpiring();
          renderOrderSelectOptions();
        });

        deleteBtn.addEventListener("click", () => {
          if (confirm(`Remove "${med.name}" from the list?`)) {
            medications = medications.filter(m => m.id !== med.id);
            saveMeds(medications);

            orders = orders.filter(o => o.medId !== med.id);
            saveOrders(orders);

            renderMeds();
            renderInventory();
            renderExpiring();
            renderOrders();
            renderOrderSelectOptions();
          }
        });

        editExpBtn.addEventListener("click", () => {
          const newDate = prompt("Enter expiration date (YYYY-MM-DD):", med.exp || "");
          if (newDate === null) return;
          const trimmed = newDate.trim();
          if (trimmed && !/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
            alert("Please enter date as YYYY-MM-DD.");
            return;
          }
          med.exp = trimmed;
          expSpan.textContent = trimmed || "Not set";
          saveMeds(medications);
          renderInventory();
          renderExpiring();
        });

        medListEl.appendChild(card);
      });
    }

    // ====== RENDER: INVENTORY ======
    function renderInventory() {
      if (!medications.length) {
        inventoryContent.innerHTML = "<p>No medications in inventory.</p>";
        return;
      }

      const sorted = [...medications].sort((a, b) =>
        a.name.toLowerCase().localeCompare(b.name.toLowerCase())
      );

      let totalQty = sorted.reduce((sum, m) => sum + (m.qty || 0), 0);

      let html = `
        <div class="inventory-summary">
          Total medications: <strong>${sorted.length}</strong> |
          Total units on shelf: <strong>${totalQty}</strong>
        </div>
        <table class="inventory-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Medication Name</th>
              <th>Expiration</th>
              <th>Barcode</th>
              <th class="text-right">On Shelf</th>
            </tr>
          </thead>
          <tbody>
      `;

      sorted.forEach((med, index) => {
        html += `
          <tr>
            <td>${index + 1}</td>
            <td>${med.name}</td>
            <td>${med.exp || "Not set"}</td>
            <td>${med.barcode || ""}</td>
            <td class="text-right">${med.qty}</td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      inventoryContent.innerHTML = html;
    }

    // ====== RENDER: EXPIRING ======
    function renderExpiring() {
      const now = new Date();
      const threshold = new Date(now.getTime());
      threshold.setMonth(threshold.getMonth() + 3);

      const expiring = medications
        .map(med => {
          if (!med.exp) return null;
          const d = new Date(med.exp);
          if (isNaN(d.getTime())) return null;
          if (d < now || d > threshold) return null;
          const daysLeft = Math.floor((d - now) / (1000 * 60 * 60 * 24));
          return { ...med, expDate: d, daysLeft };
        })
        .filter(Boolean)
        .sort((a, b) => a.expDate - b.expDate);

      if (!expiring.length) {
        expiringContent.innerHTML = "<p>No medications expiring within 3 months.</p>";
        return;
      }

      let html = `
        <table class="expiring-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Medication Name</th>
              <th>Expiration</th>
              <th>Days Left</th>
              <th>Barcode</th>
              <th class="text-right">On Shelf</th>
            </tr>
          </thead>
          <tbody>
      `;

      expiring.forEach((med, index) => {
        html += `
          <tr>
            <td>${index + 1}</td>
            <td>${med.name}</td>
            <td>${med.exp}</td>
            <td>${med.daysLeft}</td>
            <td>${med.barcode || ""}</td>
            <td class="text-right">${med.qty}</td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      expiringContent.innerHTML = html;
    }

    // ====== RENDER: ORDERS ======
    function renderOrderSelectOptions() {
      const currentValue = orderMedSelect.value;
      orderMedSelect.innerHTML = '<option value="">Select medication for order...</option>';

      medications.forEach(med => {
        const opt = document.createElement("option");
        opt.value = String(med.id);
        opt.textContent = med.name;
        orderMedSelect.appendChild(opt);
      });

      if (currentValue && [...orderMedSelect.options].some(o => o.value === currentValue)) {
        orderMedSelect.value = currentValue;
      }
    }

    function renderOrders() {
      if (!orders.length) {
        orderContent.innerHTML = "<p>No active orders.</p>";
        return;
      }

      const current = orders[0];
      const med = medications.find(m => m.id === current.medId);

      if (!med) {
        orders.shift();
        saveOrders(orders);
        renderOrders();
        return;
      }

      orderContent.innerHTML = "";

      const card = document.createElement("div");
      card.className = "order-card";

      card.innerHTML = `
        <div class="order-title">Current Order</div>
        <div class="order-line">
          <strong>Medication:</strong> ${med.name}
        </div>
        <div class="order-line">
          <strong>Order:</strong> Take <strong>${current.qty}</strong> from the shelf.
        </div>
        <div class="order-line">
          <strong>Expiration:</strong> ${med.exp || "Not set"}</div>
        <div class="order-line">
          <strong>On shelf now:</strong> ${med.qty}</div>
        <div class="order-line">
          Remaining orders in queue: <strong>${orders.length}</strong>
        </div>
        <div class="order-actions">
          <button class="btn-primary" id="acceptOrderBtn">Accept & Subtract</button>
          <button class="btn-secondary" id="skipOrderBtn">Skip / Next</button>
        </div>
      `;

      orderContent.appendChild(card);

      const acceptBtn = document.getElementById("acceptOrderBtn");
      const skipBtn = document.getElementById("skipOrderBtn");

      acceptBtn.addEventListener("click", () => {
        if (med.qty < current.qty) {
          alert(
            `Not enough on shelf.\nOn shelf: ${med.qty}\nOrder: ${current.qty}\nPlease adjust the quantity or restock first.`
          );
          return;
        }

        med.qty -= current.qty;
        saveMeds(medications);

        orders.shift();
        saveOrders(orders);

        renderMeds();
        renderInventory();
        renderExpiring();
        renderOrders();
      });

      skipBtn.addEventListener("click", () => {
        if (orders.length > 1) {
          const first = orders.shift();
          orders.push(first);
          saveOrders(orders);
        }
        renderOrders();
      });
    }

    addOrderBtn.addEventListener("click", () => {
      const medIdStr = orderMedSelect.value;
      let qty = parseInt(orderQtyInput.value, 10);

      if (!medIdStr) {
        alert("Please select a medication for the order.");
        return;
      }
      if (isNaN(qty) || qty <= 0) {
        alert("Please enter a valid order quantity.");
        return;
      }

      const medId = Number(medIdStr);
      const med = medications.find(m => m.id === medId);
      if (!med) {
        alert("Selected medication no longer exists.");
        renderOrderSelectOptions();
        return;
      }

      const newOrder = {
        id: Date.now(),
        medId: med.id,
        qty
      };

      orders.push(newOrder);
      saveOrders(orders);
      renderOrders();

      orderQtyInput.value = "";
    });

    // ====== ADJUST MODAL ======
    function showAdjustModal(med, code) {
      adjustMedId = med.id;
      adjustAmountInput.value = "1";
      adjustInfo.innerHTML =
        `<div style="margin-bottom:4px;">Medication: <strong>${med.name}</strong></div>
         <div style="margin-bottom:4px;">Barcode: <strong>${code || med.barcode}</strong></div>
         <div>On shelf now: <strong>${med.qty}</strong></div>`;
      adjustModal.classList.add("active");
    }

    function closeAdjustModal() {
      adjustMedId = null;
      adjustModal.classList.remove("active");
    }

    adjustSubtractBtn.addEventListener("click", () => {
      let amt = parseInt(adjustAmountInput.value, 10);
      if (isNaN(amt) || amt <= 0) {
        alert("Enter a valid amount.");
        return;
      }
      const med = medications.find(m => m.id === adjustMedId);
      if (!med) {
        alert("Medication not found.");
        closeAdjustModal();
        return;
      }
      if (med.qty < amt) {
        alert(`Not enough on shelf.\nOn shelf: ${med.qty}\nRequested: ${amt}`);
        return;
      }
      med.qty -= amt;
      saveMeds(medications);
      renderMeds();
      renderInventory();
      renderExpiring();
      renderOrders();
      closeAdjustModal();
    });

    adjustAddBtn.addEventListener("click", () => {
      let amt = parseInt(adjustAmountInput.value, 10);
      if (isNaN(amt) || amt <= 0) {
        alert("Enter a valid amount.");
        return;
      }
      const med = medications.find(m => m.id === adjustMedId);
      if (!med) {
        alert("Medication not found.");
        closeAdjustModal();
        return;
      }
      med.qty += amt;
      saveMeds(medications);
      renderMeds();
      renderInventory();
      renderExpiring();
      renderOrders();
      closeAdjustModal();
    });

    closeAdjustBtn.addEventListener("click", closeAdjustModal);
    adjustModal.addEventListener("click", e => {
      if (e.target === adjustModal) {
        closeAdjustModal();
      }
    });

    // ====== BARCODE SCANNER ======
    function startScanner(mode) {
      if (!window.Quagga) {
        alert("Barcode scanner library not loaded.");
        return;
      }
      scannerMode = mode || "add";
      scannerModal.classList.add("active");
      if (scannerActive) return;

      Quagga.init({
        inputStream: {
          type: "LiveStream",
          target: scannerViewport,
          constraints: {
            facingMode: "environment"
          }
        },
        decoder: {
          readers: ["ean_reader", "upc_reader", "upc_e_reader", "code_128_reader"]
        },
        locate: true
      }, function(err) {
        if (err) {
          console.error(err);
          alert("Could not start camera. Check permissions.");
          stopScanner();
          return;
        }
        Quagga.start();
        scannerActive = true;
      });

      Quagga.onDetected(onDetectedHandler);
    }

    function onDetectedHandler(result) {
      if (!result || !result.codeResult || !result.codeResult.code) return;
      const code = result.codeResult.code;

      if (scannerMode === "add") {
        const existing = medications.find(m => m.barcode === code);
        if (existing) {
          stopScanner();
          showAdjustModal(existing, code);
          return;
        }
        medBarcodeInput.value = code;
        stopScanner();
      } else if (scannerMode === "adjust") {
        const med = medications.find(m => m.barcode === code);
        if (!med) {
          alert("No medication found for scanned barcode: " + code);
          return;
        }
        stopScanner();
        showAdjustModal(med, code);
      }
    }

    function stopScanner() {
      if (window.Quagga) {
        try {
          Quagga.offDetected(onDetectedHandler);
          if (scannerActive) {
            Quagga.stop();
          }
        } catch (e) {
          console.error(e);
        }
      }
      scannerActive = false;
      scannerModal.classList.remove("active");
    }

    openScannerBtn.addEventListener("click", () => startScanner("add"));
    openAdjustScanBtn.addEventListener("click", () => startScanner("adjust"));
    closeScannerBtn.addEventListener("click", stopScanner);
    scannerModal.addEventListener("click", e => {
      if (e.target === scannerModal) {
        stopScanner();
      }
    });

    // ====== NAVIGATION ======
    const circleButtons = document.querySelectorAll(".nav-circle-btn");
    const panels = document.querySelectorAll(".tab-panel");

    circleButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-target");

        circleButtons.forEach(b => b.classList.remove("active"));
        panels.forEach(p => p.classList.remove("active"));

        btn.classList.add("active");
        document.getElementById(target).classList.add("active");

        if (target === "inventoryTab") {
          renderInventory();
        } else if (target === "ordersTab") {
          renderOrders();
        } else if (target === "expiringTab") {
          renderExpiring();
        }
      });
    });

    // ====== ADD MED ======
    addMedBtn.addEventListener("click", () => {
      const name = medNameInput.value.trim();
      let qty = parseInt(medStartQtyInput.value, 10);
      const exp = medExpInput.value.trim();
      const barcode = medBarcodeInput.value.trim();

      if (!name) {
        alert("Please enter a medication name.");
        return;
      }
      if (!barcode) {
        alert("Each item must have a barcode. Please scan or enter one.");
        return;
      }

      const existing = medications.find(m => m.barcode === barcode);
      if (existing) {
        showAdjustModal(existing, barcode);
        medBarcodeInput.value = "";
        medStartQtyInput.value = "";
        medNameInput.value = "";
        medExpInput.value = "";
        return;
      }

      if (isNaN(qty) || qty < 0) qty = 0;

      const newMed = {
        id: Date.now(),
        name,
        qty,
        exp,
        barcode
      };

      medications.push(newMed);
      saveMeds(medications);
      renderMeds();
      renderInventory();
      renderExpiring();
      renderOrderSelectOptions();

      medNameInput.value = "";
      medStartQtyInput.value = "";
      medExpInput.value = "";
      medBarcodeInput.value = "";
    });

    medNameInput.addEventListener("keydown", e => {
      if (e.key === "Enter") addMedBtn.click();
    });
    medStartQtyInput.addEventListener("keydown", e => {
      if (e.key === "Enter") addMedBtn.click();
    });

    // ====== INIT APP ======
    async function initApp() {
      orders = loadOrders();

      // Try server first
      let loadedMeds = [];
      const serverMeds = await fetchMedsFromServer();
      if (serverMeds && serverMeds.length > 0) {
        const base = Date.now();
        loadedMeds = serverMeds.map((m, i) => ({
          id: base + i,
          name: (m.name || "").trim(),
          qty: Number(m.qty) || 0,
          exp: m.exp || "",
          barcode: (m.barcode || "").trim()
        })).filter(m => m.name && m.barcode);
        saveMedsLocal(loadedMeds); // refresh local cache, don't re-sync here
      } else {
        loadedMeds = loadMedsLocal();
      }

      medications = loadedMeds;

      renderMeds();
      renderInventory();
      renderExpiring();
      renderOrderSelectOptions();
      renderOrders();
    }

    initApp();
  </script>
</body>
</html>
